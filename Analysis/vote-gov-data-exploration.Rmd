---
title: "votegov-data-exploration"
author: "Katie Worrall"
date: "2022-10-18"
output: pdf_document
---


```{r load packages}
#load packages
library(readr)
library(tidyr)
library(dplyr)
library(stringr)
library(ggplot2)
library(RItools)
library(here)
```


```{r load data sets}
#EAC Dataset:
regdat <- read_csv(here::here("Data","2020_EAVS_for_Public_Release_nolabel_V2.csv"))
#load dataset from EAC website https://www.eac.gov/research-and-data/datasets-codebooks-and-surveys)

###County Census dataset:
County <- read_csv(here::here("Data","County.csv"))
County
place <- read_csv(here::here("Data", "Place.csv"))
###Citizen Voting Age Population (CVAP) Special Tabulation From the 2016-2020 5-Year American Community Survey (ACS)
###CPS 2020 dataset:
cps20 <- read_csv(here::here("Data","cps_00002.csv"))
```


```{r EAC data}

regdat <- regdat %>% select(FIPSCode:B4Comments) #subset variable of interest. From first variable, FIPSCode to B4comments.

sum(duplicated(regdat$Jurisdiction_Name)) #some counties in US have same name in different states
table(duplicated(regdat$FIPSCode),exclude=c()) #better to use FIPSCode
table(regdat$FIPSCode=="") #better to use FIPSCode
table(nchar(regdat$FIPSCode)) 
## counties should be 5 digits
regdat$FIPSCode <- str_pad(regdat$FIPSCode, 10, side = "right", pad = 0) #first need to make them all the same width of 10, then truncate them down to 5
table(nchar(regdat$FIPSCode)) 
regdat$FIPSCode <- str_sub(regdat$FIPSCode, end = 5) #make all the same width
table(nchar(regdat$FIPSCode)) #make sure all the FIPScodes are only 5 characters
regdat$FIPSCode
#exploring voter registration totals
regdat$totreg <- regdat$A1a #change A1a to totreg (total registered voters)
regdat$totact <- regdat$A1b #change A1b to totact (total registered active voters)
##according to Stewart's paper, A1b is the best one to use: https://electionlab.mit.edu/research/voter-registration 

regdat$onlineinvalid <- regdat$A7c #change a7c to onlineinvalid 
regdat$onlinedupe <- regdat$A6c #change a6c to online duplicates
max(regdat$onlinedupe, na.rm = T) #high amount of duplicates online 
mean(regdat$onlinedupe, na.rm = T)
regdat[regdat$onlinedupe == 127272,] #CA, Solano County
regdat[regdat$totreg == -88,] #ND does not have voter registration
##looks like Kalawao County (smallest county in the US by land area, 436 pop)
##UOCAVA is overseas voters 
regdat[regdat$totact == -88, ] #North Dakota 
regdat2 <- regdat %>% select("FIPSCode", "State_Abbr", "totact", "Jurisdiction_Name", "totreg")

#remove Wisconsin
regdat2 <- regdat2 %>% filter(State_Abbr != "WI")

##fixing Wisconsin 
regdatWI <- regdat %>% filter(State_Abbr == "WI")
regdatWI$Jurisdiction_Name <- sub('.*?[--]', '', regdatWI$Jurisdiction_Name)
regdatWI$FIPSCode <- as.numeric(regdatWI$FIPSCode) #turn numeric so I can include a fake FIPScode to replace later
regdatWI
regdatWI <- regdatWI %>% group_by(Jurisdiction_Name, State_Abbr) %>%
	summarise(totreg = sum(totreg), FIPSCode = sum(FIPSCode), totact = sum(totact))
regdatWI$FIPSCode <- as.character(regdatWI$FIPSCode) #back to character class for replacement
regdatWI$Jurisdiction_Name <- str_squish(regdatWI$Jurisdiction_Name)
regdatWI %>% filter(Jurisdiction_Name == "MULTIPLE COUNTIES")#this is an error in the WI data, a bunch of voter registration were just put in this observation. I am not sure which county these are for.
regdatWI <- regdatWI %>% filter(Jurisdiction_Name != "MULTIPLE COUNTIES") #removing for now.
regdatWI <- regdatWI %>% filter(Jurisdiction_Name != "LAKES - VILAS COUNTY")
regdatWI$FIPSCode <- c(55001,55003,55005,55007,55009,55011,
55013,55015,55017,55019,55021,55023,55025,55027,55029,55031,55033,55035,55037,55039,55041,55043,55045,
55047,55049,55051,55053,55055,55057,55059,	55061,55063,55065,55067,55069,55071,55073,55075,55077,
55078,55079,55081,55083,55085,55087,55089,55091,55093,55095,55097,55099,55101,55103,55105,55107,55109,
55111,55113,55115,55117,55119,55121,55123,55125,55127,55129,55131,55133,55135,55137,55139,55141) #replace FIPSCodes
regdatWI$FIPSCode <- as.character(regdatWI$FIPSCode)

##readding Wisconsin observations
regdat3 <- bind_rows(regdatWI, regdat2)

#remove missing values
regdat4 <- regdat3 %>% filter(totact != -88) #remove missing values
regdat4 <- regdat4 %>% filter(totact != -99) #remove missing values
regdat4

#merging IL and MO cities with their counties
regdat4$FIPSCode <- replace(regdat4$FIPSCode, regdat4$FIPSCode == "17066", "17113")
regdat4$FIPSCode <- replace(regdat4$FIPSCode, regdat4$FIPSCode == "17140", "17031")
regdat4$FIPSCode <- replace(regdat4$FIPSCode, regdat4$FIPSCode == "17222", "17163")
regdat4$FIPSCode <- replace(regdat4$FIPSCode, regdat4$FIPSCode == "17283", "17095")
regdat4$FIPSCode <- replace(regdat4$FIPSCode, regdat4$FIPSCode == "17650", "17201")
regdat4$FIPSCode <- replace(regdat4$FIPSCode, regdat4$FIPSCode == "29380", "29095")

##states/territories not included fully in this dataset:
regdat %>% filter(State_Abbr =="AK")
regdat %>% filter(State_Abbr =="PR")
regdat %>% filter(State_Abbr =="AS")
regdat %>% filter(State_Abbr =="GU")
regdat %>% filter(State_Abbr =="MP")
regdat %>% filter(State_Abbr =="ND") #no voter registration 

```

```{r ACS VAP by race and ethnicity data}
tail(County$geoid) #changing to be same format as FIPSCode in regdat
County$FIPSCode <- County$geoid
County$FIPSCode <- str_sub(County$FIPSCode, start= 10L, end = 15L) #remove everything before S
County$FIPSCode
tail(regdat$FIPSCode)
table(nchar(County$FIPSCode)) ##check 5 digits
colnames(County)
county1 <- County %>% select("geoname", "FIPSCode", "lntitle", "cvap_est")
county1 <- pivot_wider(county1, names_from = "lntitle", values_from = "cvap_est")
County %>% filter(geoname == "Stark County, Illinois") #Stark County registration data is wrong.
county1$hispanicrate <- county1$`Hispanic or Latino`
county1$blackafamrate <- county1$`Black or African American Alone`
county1$amindaknativerate <- county1$`American Indian or Alaska Native Alone`
county1$nativehawrate <- county1$`Native Hawaiian or Other Pacific Islander Alone` 
county1$asianrate <- county1$`Asian Alone`

```


```{r merge}
vregdat <- left_join(regdat4, county1, by = "FIPSCode") #merge datasets
anti_join(regdat4, county1, by = "FIPSCode") #there are towns in ME that did not get included, all their voter registration rates are high, so I will leave them out for now.

colnames(vregdat) #include all column names that are shared 
vregdat1 <- vregdat %>% group_by(FIPSCode, geoname, State_Abbr, Total, asianrate, nativehawrate,
																 amindaknativerate, blackafamrate, hispanicrate) %>%
	summarise(totact = sum(totact), totreg = sum(totreg))
vregdat1 #for now, we are not working with Wisconsin, I will have to Wisconsin separately and add it to the whole data set later. (also AK, PR, GU, MP, VI, AS are all state/territory level data, not county)

vregdat1$vrateact <- (vregdat1$totact)/(vregdat1$Total)#total active registered
vregdat1$vratereg <-  (vregdat1$totreg)/(vregdat1$Total) #total registered
vregdat1$hispanicrate <- (vregdat1$hispanicrate)/(vregdat1$Total)
vregdat1$asianrate <- (vregdat1$asianrate)/(vregdat1$Total)
vregdat1$blackafamrate <- (vregdat1$blackafamrate)/(vregdat1$Total)
vregdat1$amindaknativerate <- (vregdat1$amindaknativerate)/(vregdat1$Total)
vregdat1$nativehawrate <- (vregdat1$nativehawrate)/(vregdat1$Total)
min(vregdat1$vratereg, na.rm =  T)
quantile(vregdat1$vratereg, na.rm = T)
vregdat1[order(vregdat1$vrateact, decreasing = F),]
vregdat1[order(vregdat1$vratereg, decreasing = F),] #total registered seems a better measure
vregdat1 <- vregdat1 %>% filter(vratereg < 2) #there are a few errors in reporting data.

vregdatquant <- vregdat1 %>% filter(vratereg < .75) #narrows down to places with less than 75% registration rate, the lower quarter quantile. 
vregdatquant$geoname #places in the US with the lowest voter registration rates. 
unique(vregdatquant$State_Abbr) #of these, many have same-day voter registration, however those that do not are(https://www.ncsl.org/research/elections-and-campaigns/same-day-registration.aspx):
#Arkansas
#North Carolina
#Florida
#Georgia
#Indiana
#Kansas
#TN
#TX
#LA
#MO
#MT
#NE
#OH
#PA
#WV
#OK
#
#voter registration rates by county starting from lowest:
vregdat1[order(vregdat1$vratereg, decreasing = F),] 
```


```{r figures}
vreg_freqplot <- ggplot(data = vregdatquant, mapping = aes(vratereg)) +
	geom_histogram() 	#frequency of voter registration rates by county
vreg_freqplot
ggplot(data = vregdatquant, mapping = aes(blackafamrate, vratereg)) +
	geom_point() +
	geom_label(aes(label=geoname))
ggplot(data = vregdatquant, mapping = aes(asianrate, vratereg)) +
	geom_point()+
	geom_label(aes(label=geoname))
ggplot(data = vregdatquant, mapping = aes(hispanicrate, vratereg)) +
	geom_point() +
	geom_label(aes(label=geoname))
ggplot(data = vregdatquant, mapping = aes(nativehawrate, vratereg)) +
	geom_point() +
	geom_label(aes(label=geoname))
ggplot(data = vregdat1, mapping = aes(amindaknativerate, vratereg)) +
	geom_point()+
	geom_label(aes(label=geoname))
```



Important Variables from EAVS data:
A1: Registered Voters
A2: Same day voter registration
A4-7: source of voter registration
A9: removed from voter rolls
B1-4: data on military voter registration

From codebook:
FIPS        
Jurisdiction Name       
State Name (Full)      
State Name (Abbreviation)      
A1a Total Reg      
A1b Total Active      
A1c Total Inactive      
A2a Total SDR      
A2b Election Day SDR     
A2c SDR Prior To Election Day   
A4a Mail Total      
A4b In-person Total      
A4c ****Online Total      
A4d DMV Total      
A4e NVRA Mandated Total     
A4f Disabilities Agency Total     
A4g Armed Forces Total     
A4h Non-NVRA Mandated Total     
A4i Registered Drives Total     
A4-7j Other Text      
A4j Other       
A4-7k Other Text      
A4k Other       
A4-7l Other Text      
A4l Other       
A5a Mail New Reg     
A5b In-person New Reg     
A5c *****Online New Reg     
A5d DMV New Reg     
A5e NVRA Mandated New Reg    
A5f Disabilities Agency New Reg    
A5g Armed Forces New Reg    
A5h Non-NVRA Mandated New Reg    
A5i Registered Drives New Reg    
A4-7j Other Text      
A5j Other       
A4-7k Other Text      
A5k Other       
A4-7l Other Text      
A5l Other       
A6a Mail Dupes      
A6b In-person Dupes      
A6c ****Online Dupes      
A6d DMV Dupes      
A6e NVRA Mandated Dupes     
A6f Disabilities Agency Dupes     
A6g Armed Forces Dupes     
A6h Non-NVRA Mandated Dupes     
A6i Registered Drives Dupes     
A4-7j Other Text      
A6j Other       
A4-7k Other Text      
A6k Other       
A4-7l Other Text      
A6l Other       
A7a Mail Invalid      
A7b In-person Invalid      
***A7c Online Invalid      
A7d DMV Invalid      
A7e NVRA Mandated Invalid     
A7f Disabilities Agency Invalid     
A7g Armed Forces Invalid     
A7h Non-NVRA Mandated Invalid     
A7i Registered Drives Invalid     
A4-7j Other Text      
A7j Other       
A4-7k Other Text      
A7k Other       
A4-7l Other Text      
A7l Other       
A4_A7 Comments       
A9e Removed Fail Response   

##could potentially be important:
A8a Notifications Total      
A8b Notifications Received Confirming     
Notifications Received Invalidating      
A8d Notifications Returned Undeliverable     
A8e Notifications Status Unknown     
A8f Other Text      
A8f Other       
A8g Other Text      
A8g Other       
A8h Other Text      
A8h Other       
A8 Comments       

##military:
B1a Total Reg      
B1b Uniformed Service Total     
B1c Non-military Total      
B1 Comments       
B2a Total FPCA      
B2b Uniformed Service Total     
B2c Non-military Total      
B2 Comments       
B3a Rejected FPCA Total     
B3b Uniformed Service Rejected Total    
B3c Non-military Rejected Total     
B3 Comments       
B4a Late FPCA Total     
B4 Comments  
